rm(list=ls())
source("common_utils.R")

gpd_neg_loglikelihood <- function(x, data, u) {
  scale <- x[1]
  shape <- x[2]
  xx_u <- data[data > u] - u
  if (shape == 0) {
    out <- (-log(scale)-xx_u/scale)
  } else {
    out <- (-log(scale)-(1+1/shape)*log(1+shape/scale*xx_u))
  }
  out <- -sum(out)
  if (is.na(out)){
    out <-.Machine$double.xmax
  }
  return(out)
}

gpd_neg_loglikelihood_derivative <- function(x, data, u) {
  scale <- x[1]
  shape <- x[2]  
  xx_u <- data[data > u] - u
  dlll_dscale <- -1/scale +(1+shape)*xx_u/(scale**2 + scale*shape*xx_u)
  dlll_dshape <- 1/shape**2*log(1+shape*xx_u/scale) -(1+shape)*xx_u/(shape*scale+shape**2*xx_u)
  out_dscale <- -sum(dlll_dscale)
  out_dshape <- -sum(dlll_dshape)
  out <- c(out_dscale, out_dshape)
  return(out)
}

pgpd <- function(x, loc, scale, shape) {
  if (shape == 0) {
    return(1-log(-(x-loc)/scale))
  } else {
    return(1-(1+shape/scale*(x-loc))**(-1/shape))
  }
}

eval_llh_f <- function(x, data, u) {
  objective <- gpd_neg_loglikelihood(x, data, u)
  grad <- gpd_neg_loglikelihood_derivative(x, data, u)
  return( list( "objective"=objective, "gradient"=grad ) )  
}
eval_llh_g_ineq <- function(x, data, u) {
    xx_u = data[data>u] -u
    scale <- x[1]
    shape <- x[2]
    constr1 <- -shape*(xx_u)-scale
    grad1_scale  <- -rep(1, length(xx_u))
    grad1_shape  <- -xx_u
    constr <- c(constr1)
    grad   <- cbind(grad1_scale, grad1_shape)
    return( list( "constraints"=constr, "jacobian"=grad ) )
}

eval_tip <- function(x, data, u, lhs, rhs) {
  scale <- x[1]
  shape <- x[2]
  tail_internval_probability <- pgpd(rhs, u, scale, shape) - pgpd(lhs, u, scale, shape)
  return(tail_internval_probability)
}

sampleProposal <- function(x0, prior_scale, prior_shape, u) {
  # Generate samples
  repeat {
    xstar <- mvrnorm(1, mu = x0, Sigma = matrix(c(1, 0, 0, 1), nrow = 2))
    if (xstar[1] > prior_scale[1] && xstar[1] < prior_scale[2] &&
        xstar[2] > prior_shape[1] && xstar[2] < prior_shape[2]
    ) {
      # notice the proposal probability distributio ratio is equal to 1 so we skip the term
      # in the code, i.e. Q(xstar|x0) = Q(x0|xstar) if Q(x'|x) ~ N(x, I). 
      accrej <- exp( min(0, -gpd_neg_loglikelihood(xstar, data, u) + 
                             gpd_neg_loglikelihood(x0,    data, u))
      )
      if (runif(1, min = 0, max = 1) < accrej) {
        return(xstar)
      }
      
    }
  }
}

estimateTIPviaMCMC <- function(x0, prior_scale, prior_shape, 
                               data, u, lhs, rhs, conf) {
  burnIn <- 20000
  for ( i in 1:burnIn ){
    x0 <- sampleProposal(x0, prior_scale, prior_shape, u)
  }
  chainLength <- 1000
  tip <- rep(NA, chainLength)
  tip_idx <- 1 
  base_probability <- sum(data>u)/length(data)   
  for ( i in 1 : chainLength  ){
    tip[tip_idx] = base_probability*eval_tip(x=x0, data=data, u=u, lhs=lhs, rhs=rhs)
    x0 <- sampleProposal(x0, prior_scale, prior_shape, u)
    tip_idx = tip_idx + 1    
  }
  return(quantile(tip, probs = c(0, conf), na.rm=TRUE))
}

# estimateTIPviaMCMC <- function(x0, prior_scale, prior_shape, 
#                                data, u, lhs, rhs, conf) {
#   burnIn <- 10000
#   for ( i in 1:burnIn ){
#     x0 <- sampleProposal(x0, prior_scale, prior_shape, u)
#   }
#   chainLength <- 50001
#   chain = matrix(NA, nrow = chainLength, ncol = 2)
#   chain[1, ] <- x0
#   for ( i in 2 : chainLength  ){
#     chain[i, ] <- sampleProposal(chain[i-1,], prior_scale, prior_shape, u)
#   }

#   mcmc_chain = mcmc(chain)
  
#   ess_results_max <- -Inf
#   remainSize = 1000
#   # for ( proposeSize in seq(1000, round(chainLength/2), 1000)) {
#   #   ess_results_ratio <- effectiveSize(mcmc(chain[ (nrow(chain)-proposeSize):nrow(chain),]))/proposeSize
#   #   print(sum(ess_results_ratio))
#   #   if ( sum(ess_results_ratio) > ess_results_max) {
#   #     ess_results_max <- sum(ess_results_ratio) 
#   #     remainSize <- proposeSize 
#   #   }
#   # }

#   base_probability <- sum(data>u)/length(data) 
#   tip <- rep(NA, remainSize+1)
#   tip_idx <- 1
#   for ( i in (nrow(chain)-remainSize):nrow(chain)) {
#     tip[tip_idx] = base_probability*eval_tip(x=chain[i,], data=data, u=u, lhs=lhs, rhs=rhs)
#     tip_idx = tip_idx + 1
#   }
#   return(quantile(tip, probs = c(0, conf)))
# }

gpdTIP <- function(data, lhs, rhs, conf = .95) {

  if(lhs >= rhs) {
    stop("Left end point must be smaller than right end point!")
  }

  u <- gof_find_threshold(data)
  if (is.null(u)) {
    u <- gof_find_threshold(data, bootstrap=TRUE)
  }
  base_probability <- sum(data>u)/length(data) 
  # Find initial point for the following MCMC method to estimate credible interval for TIP.
  suppressWarnings(z <- POT::fitgpd(data, threshold = u, est = 'mle'))
  x0 = c(as.numeric(z$param[1]), as.numeric(z$param[2]))

  estimate <- NaN

  shape_min <- 
  prior_scale <- c(max(0, x0[1] -1), x0[1] + 1)
  prior_shape <- c(x0[2] - 1, x0[2] + 1)

  bound_val <- estimateTIPviaMCMC(x=x0, prior_scale=prior_scale, prior_shape=prior_shape,
                                  data=data, u=u, lhs=lhs, rhs=rhs, conf=.95)

  CI <- c(bound_val[1], bound_val[2])
  out <- list(estimate, CI, conf)
  names(out) <- c("Estimate", "CI", "ConfLevel")
  out
}
# library(MASS)
# library(coda)  # Load the coda package



# lhs <- 10.240473656312131

# rhs <- 13.142211523154549

# data <- c(0.33436214527025565, 0.5060824232403254, 1.6835207186890855, 1.1998563141264431, 1.111959025097565, 0.6189341138466388, 0.42964668926274496, 0.9391972416413017, 0.7701940463792458, 4.3960808810078, 3.1820876993411096, 1.0491206066623617, 1.7989753005828906, 0.6363483608097231, 3.9605771397109284, 0.8331841308451111, 0.44339658675140786, 1.7625370961806297, 0.6355978076973837, 0.15242625532475018, 1.0116926854514177, 0.40459532937618553, 0.8288940240474749, 1.649632717186181, 4.265967386071179, 0.6866149928756761, 0.9269979972548767, 1.3089591178301498, 1.2684641424110903, 1.5514397946298721, 0.6064829966304675, 2.0792182303795665, 3.478194200572373, 1.1665952077103834, 3.083019293846791, 0.5704581686245576, 1.254890489765373, 8.767857243764961, 2.9552992034300285, 0.9439875723603295, 0.2401285922363671, 1.1026817610215234, 0.5633398290688861, 4.449070576429523, 0.35758734205769255, 4.466411710463857, 0.36522653397647664, 1.1469961121403593, 4.875057539264245, 0.1308521700899521, 0.20904551308789845, 2.4688654643060244, 6.738426342640654, 0.27059317865601823, 0.8618723448087096, 0.27001689767184384, 0.9748611361623583, 0.0676848096422588, 1.8683343875710148, 0.22223564639524734, 2.3483904309344936, 0.2762705114646983, 0.14795403973050775, 1.2680106451179658, 1.0203691905021308, 2.4313520751841993, 0.40434123683381307, 1.2301180625543053, 0.40714546912125943, 0.1638801486370966, 2.2763487948186434, 0.23341711781506916, 7.40500906325024, 0.6280449916193841, 0.5545151292188799, 0.12029568266047044, 0.8606718436963473, 0.6577566943129591, 1.4490708019878416, 1.1221098814830606, 0.5786053565496031, 0.5036650018258669, 0.4917998553382338, 2.8598043074841795, 0.2828259290498607, 0.7735151110982483, 4.513143451643717, 0.868699012228544, 4.337635425469513, 5.052205174719384, 0.8868098396067814, 1.7783051266736363, 2.0715419988736525, 1.5061945576386322, 0.6119606047253408, 0.8750097699158165, 0.3904940690022239, 0.7210650105722665, 1.3468623853424155, 0.5497130596040379, 1.3423941647131954, 1.1687507707541505, 0.2704752112867103, 2.526795791825957, 0.3501330140305489, 0.6047445382834367, 8.06393145561661, 0.30202093197536495, 0.584944759204954, 0.4195446973866695, 0.4989806263088172, 2.5384369198328556, 0.07471269175329001, 1.2188883394812304, 0.8935221923879384, 1.3080495035501973, 1.1921190112785287, 1.6294729559599974, 2.2139844251782206, 0.8781675860077446, 1.4328066403037503, 0.773917846683132, 0.6586344476685547, 1.176866900553055, 1.0665387504058934, 0.7776113359461018, 3.0159550898838177, 0.4827792165410442, 0.6648483006954572, 2.1277731939484217, 0.6108047557168442, 1.4780989477443551, 0.14285195339513382, 1.4690034502455536, 4.204523188044963, 0.1216580885611345, 0.7975968611025404, 4.041518824115882, 0.7861768280298052, 1.322250068780712, 1.2324023835545297, 1.96277245845948, 0.28872659342122675, 2.365015078451664, 0.15031651290746753, 0.6383920291586225, 0.4660171715371045, 2.5948546604550957, 4.966463515355832, 1.182848602189599, 0.4941814682756108, 0.19616046697296088, 0.1908770136414704, 0.5392905478890845, 0.4251999012331219, 2.726131593932002, 0.7164592885442331, 1.39621583721786, 0.4308162197467854, 0.8239872026130863, 0.908632291901992, 0.44871085206905775, 3.3718965045270157, 1.3779343475371426, 2.5002865109962378, 0.8936261314815775, 4.5133790636920015, 0.8647556496750488, 3.659351971221037, 2.501633159361516, 0.10623164149596752, 0.5874388961506988, 1.4042059208600615, 0.41337048933705195, 6.260296743724435, 0.29026392123464845, 2.83030447389737, 0.6493188399719511, 0.5501099436798128, 0.7225406209884536, 2.343023555834112, 0.31273476969548664, 0.3796553528475328, 5.293872020282098, 0.8215480087347311, 0.31549550551067845, 1.3109750346020685, 0.42942650635917606, 0.5462981855800463, 0.8555009456242358, 2.3368051941433645, 2.4909484394976062, 0.3452989932308685, 1.1375734638756319, 5.635707211752658, 0.19994646846447742, 3.0117798421417454, 2.83309439077215, 1.138381434301575, 1.0056446428195498, 0.9667970798937212, 1.377985838600728, 0.8262281529486655, 2.5640247212885323, 1.6672105532934416, 1.5510701160050457, 0.8876738421814943, 0.5087549148728252, 0.9023071342149356, 1.7970151706052624, 0.5156051802931751, 5.457843797419067, 0.4390859702797278, 0.45318050672096455, 0.8245893464387751, 0.22925039798197738, 0.29185726347999885, 1.4121396827046768, 1.4779377812334131, 3.7980745783083583, 0.26602964871554735, 2.633207900165491, 4.897285830220315, 2.658498859879765, 0.8814261885225066, 0.41201944717086864, 0.5104121926401525, 3.6699583051709586, 3.621767469440635, 0.5701317119392587, 1.0771458507398057, 0.5200424679234068, 0.658210275825829, 2.4156081575193915, 0.2778912049228826, 0.42784463250006266, 1.1855725474185899, 0.36861596849393596, 0.21292257045392926, 0.9824535497494801, 0.24929879135902167, 1.393159948695394, 0.10444724304238218, 2.11746753769952, 1.097078141976672, 2.8914592534587724, 3.319530997705569, 2.569077112481131, 0.4070266172885362, 4.3302911983140415, 0.8025319569902981, 1.4626384647015453, 4.234171270577617, 0.7215786059041592, 0.8528870631919304, 2.3084781936685244, 0.7913779898328563, 0.5927255400671514, 0.13534925178984822, 1.0371095793861465, 0.523063419806228, 0.15712905877905756, 1.1718728049580363, 0.7005739303416347, 0.37999106694728024, 0.30830600891492677, 0.745799556022783, 0.1919090112101423, 3.903798052298964, 0.7619695233051916, 0.3586288056457269, 2.174869406606444, 0.8097907851138889, 1.7372441110742176, 2.6350965346384547, 0.1874158351597178, 0.8528909286727455, 0.2082610515498898, 3.0757611687617437, 0.8095315469195609, 2.8728095450386535, 2.7479924069264032, 0.6877099675693282, 0.874850494570859, 0.40876002133510786, 0.7650878694062724, 0.5851649351799031, 0.7295868486903452, 0.8509055566247226, 2.024629374812095, 0.8927381864790506, 1.1093926602115323, 2.8644621950661047, 0.7363605227371991, 0.2593195068134211, 8.568701681184118, 0.8710427981485932, 2.2292818616811836, 1.2744775854593426, 0.06464571357870641, 1.2973253501115312, 11.380290406809205, 3.5907360458450572, 0.4573229802527377, 0.30914962468888874, 0.36813514019107096, 0.7495532229588103, 2.129010013883088, 0.5567009946825054, 0.44049473131004224, 0.14746546451388617, 0.7581359488978026, 0.37539970810609613, 0.582503768311286, 1.0353104231388934, 1.1224495807966046, 1.1288795590313883, 2.353809813569988, 0.6349106308713467, 1.3322575480630852, 1.033936286134674, 0.8496742980934687, 0.17391670045265853, 9.376294012522944, 0.7629400431755061, 4.470524300688917, 3.297732071607154, 0.7297823057701737, 0.47370390483793984, 2.8397504520545516, 0.2881392363556403, 2.549342005078205, 1.2803492783264268, 0.3292020563005948, 2.5278778471095884, 2.5641321525080425, 1.51858729477272, 0.37825978300409485, 1.4039697156223971, 1.1490892783939137, 2.943778596120558, 2.3076031566036925, 2.1831463838509366, 1.4700774495571673, 1.114387128741575, 0.859013611930046, 1.807679948568242, 2.210892013056187, 0.7197911782372683, 0.8813679630638739, 0.5253348868142493, 0.5385411361153489, 0.6214534973261983, 1.7582215574948346, 1.4372358142447677, 0.31097284483159054, 0.22036461138132007, 1.3848805066974152, 0.4939155058465442, 1.4570714263442914, 0.916013915122935, 0.2587620601281885, 2.298344494403373, 0.7578512855386461, 0.9155375673751525, 1.8026318875965093, 0.6953246909187085, 0.1014925004715565, 0.24667364421078966, 0.7197353194771342, 0.5789995999332709, 1.2027886710352056, 2.0550924189223556, 0.500700212387238, 0.4265290377362006, 0.7145930739362631, 1.8099014353098726, 5.0377929586867864, 1.2313583797291057, 0.26800966826485384, 0.15156593669788299, 2.241687353658322, 3.8479655629535396, 0.4688287557336069, 0.3850658791995759, 1.4391304937308682, 0.666645635872734, 4.114736188803307, 7.945176167725591, 1.709206408052762, 2.6164162260568733, 0.7069509346737562, 0.4226096350980024, 1.2954790493423345, 1.8230709384103319, 2.3076265996091325, 0.36589167871972006, 2.485048855043675, 0.3457484466919, 0.43432783209253983, 0.23377464604900233, 0.5398184165494023, 0.5688310195796837, 2.0630318263818497, 5.535639809507717, 0.8537068954781906, 0.9270773060057906, 2.2545926377905485, 0.869438046296173, 0.5074253340078297, 0.9135092214568865, 0.8978791439019411, 2.5167072529580192, 0.5893859983484298, 2.5982310271626585, 1.3303266933274205, 1.459585025537867, 0.9502621640240013, 2.5327477665450497, 0.17980828485348946, 2.774034659022637, 0.4491268292919494, 2.3188388224847216, 0.3497973265115739, 0.713765601555887, 0.2160218459271412, 0.6743051867561537, 0.7518996954100252, 1.3988906520053863, 3.63434148258281, 6.449565498826831, 1.953156663709119, 0.5032823323256408, 2.857927209758393, 0.9135884786951703, 1.2101452151932683, 0.2746767959806457, 1.2743946391091205, 0.7957144221369484, 1.8119820540787865, 0.1769545784664703, 0.4460511163210078, 3.537084403763112, 2.666064526049762, 0.25971231378713616, 1.8801126268733372, 1.0388415978864134, 2.0095920083120653, 1.4903064647738447, 0.36487428347041656, 0.6077502690603518, 0.7023784063367471, 0.9228335449217437, 0.633395888554804, 2.5842915991554634, 0.4869549482551148, 0.967092488171953, 1.5767018010271037, 0.6790476745468103, 9.848870613539647, 0.356382378995722, 0.2199261439980526, 0.27087958506448206, 0.7845926516856305, 1.1010895048408795, 0.8769200904063, 3.62559397982044, 0.33316475016843355, 0.7290188419828321, 4.0368373358929945, 1.3729630799536074, 1.8955207882740168, 1.542548640626679, 1.3562852203466593, 1.7050800451649704, 0.1742926112286831, 0.6396174733439034, 0.3608532255753667, 0.7275647735006986, 0.9423065178235284, 1.8062527500907737, 2.334324179808302, 0.3546753017571327, 0.2614063712995009, 0.3618163033214874, 0.8528066822949026, 0.4551142632345975, 0.8720894772156732, 0.6127811710424292, 1.222651502700628, 0.6157473627876723, 0.6924451697644018, 0.4622974709018503, 0.5866216295845452, 0.4720978931457272, 2.5702059588457136, 0.3481541662625005, 9.569218608041634, 1.6126647884376757, 0.4668493790581428)

# out <- gpdTIP(data, lhs, rhs, conf=0.95)


# out <- tryCatch(
# error = function(e) e
# )
# # warnings()
# if ("error" %in% class(out)) {
#   print(out)
# }

# bbd <- if ("error" %in% class(out)) NA else{
#     out$CI
# }
# bbd                     

test <- function() {
    success_cnt <- 0
    scale_true <- 1
    shape_true <- 1.5
    nsample <- 500
    num_rep <- 2
    lhs <- POT::qgpd(p=0.99, loc = 0, scale = scale_true, shape = shape_true)
    rhs <- POT::qgpd(p=0.995, loc = 0, scale = scale_true, shape = shape_true)
    tail_prob_true <- POT::pgpd(q=rhs, loc = 0, scale = scale_true, shape = shape_true) -
                      POT::pgpd(q=lhs, loc = 0, scale = scale_true, shape = shape_true)
    conf <- 0.95
    set.seed(4)
    for (index in 1:num_rep) {
      data <- POT::rgpd(nsample, loc = 0, scale = scale_true, shape = shape_true) 
      out <- gpdTIP(data, lhs, rhs, conf)
      writeLines(sprintf("True value is %f", tail_prob_true))
      writeLines(sprintf("95%% confidence interval is [%f, %f]", out$CI[1], out$CI[2]))
      if (out$CI[1] < tail_prob_true && out$CI[2] > tail_prob_true) {
        success_cnt <- success_cnt + 1 
      }  
    }
    writeLines(sprintf("coverage probability: %f", success_cnt/num_rep))
}

# helper function: check.derivatives(...), nl.grad
# nl.opts(...): stopval, xtol_rel, maxeval, ftol_rel, ftol_abs, check_derivatives = FALSE
# f(x) = POT::pgpd(rhs, loc = u, scale = x1, shape = x2) - POT::pgpd(lhs, loc = u, scale = x1, shape = x2)
#

